<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Folder Image Thumbnails with CSV Export & Progress</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 1rem;
    }
    
    h1 {
      margin-bottom: 0.5rem;
    }

    #thumbnails {
      margin-top: 1rem;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    #thumbnails img {
      border: 1px solid #ccc;
      border-radius: 4px;
      width: 100px;
      height: auto;
      object-fit: contain;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
    }

    #instructions {
      font-size: 0.9rem;
      color: #555;
      margin-bottom: 1rem;
    }

    #statusContainer {
        display:none;
    }

    #status {
      margin-top: 1rem;
      font-size: 0.95rem;
      color: green;
    }

    /* Progress Bar container */
    #progressContainer {
      display:none;
      margin-top: 1rem;
      width: 100%;
      max-width: 400px;
      height: 20px;
      background-color: #eee;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
    }

    /* Progress Bar fill */
    #progressBar {
      height: 100%;
      width: 0%;
      background-color: #4caf50;
      transition: width 0.3s ease;
      line-height: 20px;
      color: white;
      text-align: center;
      font-size: 0.85rem;
      user-select: none;
    }


    #stopButton {
      display: none;
      margin-left: 15px;
      padding: 5px 12px;
      font-size: 0.9rem;
      cursor: pointer;
      vertical-align: middle;
      border: 1px solid #d33;
      background-color: #f44336;
      color: white;
      border-radius: 4px;
      user-select: none;
      transition: background-color 0.3s ease;
    }
    #stopButton:disabled {
      background-color: #f99;
      border-color: #f99;
      cursor: default;
    }
    #stopButton:hover:not(:disabled) {
      background-color: #d32f2f;
      border-color: #d32f2f;
    }

  </style>
</head>
<body>
  <h1>Folder to Data URL</h1>
  <p id="instructions">
    Select a folder containing images (works in Chromium-based browsers). The first thumbnails will be displayed below.

    After processing, a CSV file containing filename and Base64 data URLs for all images will be downloaded automatically.
  </p>

  <!-- Folder selector -->
  <div id="folderContainer">
  <input type="file" id="folderPicker" webkitdirectory multiple />
  </div>

  <!-- Progress bar -->
  <div id="statusContainer">
      <div id="progressContainer" aria-label="Processing progress">
        <div id="progressBar">0%</div>
      </div>
      <button id="stopButton" type="button">Stop</button>
      <div id="status"></div>
  </div>


  <div id="thumbnails"></div>

  <script>
    const folderContainer = document.getElementById('folderContainer');
    const statusContainer = document.getElementById('statusContainer');
    const progressContainer = document.getElementById('progressContainer');

    const folderPicker = document.getElementById('folderPicker');
    const thumbnailsContainer = document.getElementById('thumbnails');
    const statusElem = document.getElementById('status');
    const progressBar = document.getElementById('progressBar');
    const stopButton = document.getElementById('stopButton');
    let stopRequested = false;

    folderPicker.addEventListener('change', async (event) => {
      const files = event.target.files;

      // Reset stop flag on new start
      stopRequested = false;
      stopButton.disabled = false;

      thumbnailsContainer.innerHTML = ''; // Clear previous thumbnails
      statusElem.textContent = '';
      folderContainer.style.display = 'none';
      statusContainer.style.display = 'block';
      progressContainer.style.display = 'block';
      stopButton.style.display = 'inline-block';
      updateProgress(0);

      // Filter image files only
      const imageFiles = Array.from(files).filter(file => file.type.startsWith('image/'));

      if (imageFiles.length === 0) {
        statusElem.textContent = 'No image files found in the selected folder.';
        resetUI();
        return;
      }

      statusElem.textContent = `Processing ${imageFiles.length} images...`;

      const csvRows = [];
      csvRows.push(['Filename', 'Base64DataURL']); // header row

      // Show max 40 thumbnails
      const maxThumbnails = 100;

      for (let i = 0; i < imageFiles.length; i++) {
        if (stopRequested) {
          statusElem.textContent = `Processing stopped by user after ${i} images.`;
          break;
        }

        const file = imageFiles[i];

        try {
          const base64DataURL = await createThumbnail(file, 100, 100);

          csvRows.push([escapeCsvValue(file.name), escapeCsvValue(base64DataURL)]);

          if (i < maxThumbnails) {
            const img = document.createElement('img');
            img.src = base64DataURL;
            img.alt = file.name;
            thumbnailsContainer.appendChild(img);
          }

        } catch (error) {
          console.error(`Error processing file ${file.name}`, error);
        }

        // Update progress bar
        const progressPercent = Math.round(((i + 1) / imageFiles.length) * 100);
        updateProgress(progressPercent);
      }

      if (!stopRequested) {
        statusElem.textContent = `Processed ${imageFiles.length} images. Preparing CSV download...`;

        const csvContent = csvRows.map(row => row.join(',')).join('\r\n');
        downloadCsv(csvContent, 'images_data.csv');

        statusElem.textContent = `Finished! CSV download started. Displaying first ${Math.min(imageFiles.length, maxThumbnails)} thumbnails.`;
        updateProgress(100);
      }

      // Disable stop button at the end
      stopButton.style.display = 'none';
      progressContainer.style.display = 'none';
      folderContainer.style.display = 'block';
    });

    stopButton.addEventListener('click', () => {
      stopRequested = true;
      stopButton.disabled = true;
      statusElem.textContent = 'Stop requested, finishing current image...';
    });

    function resetUI() {
      progressContainer.style.display = 'none';
      folderContainer.style.display = 'block';
      thumbnailsContainer.innerHTML = '';
      statusElem.textContent = '';
      stopRequested = false;
      stopButton.disabled = false;

      updateProgress(0);
    }

    function updateProgress(percent) {
      progressBar.style.width = percent + '%';
      progressBar.textContent = percent + '%';
    }

    /**
     * Creates a thumbnail from an image file.
     *
     * @param {File} file - Image file to process
     * @param {number} maxWidth - Maximum thumb width
     * @param {number} maxHeight - Maximum thumb height
     * @returns {Promise<string>} - Promise resolving to base64 data URL of the thumbnail
     */
    function createThumbnail(file, maxWidth, maxHeight) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();

        reader.onload = event => {
          const img = new Image();
          img.onload = () => {
            let width = img.width;
            let height = img.height;

            if (width > height) {
              if (width > maxWidth) {
                height = Math.round(height * (maxWidth / width));
                width = maxWidth;
              }
            } else {
              if (height > maxHeight) {
                width = Math.round(width * (maxHeight / height));
                height = maxHeight;
              }
            }

            const canvas = document.createElement('canvas');
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);

            const dataURL = canvas.toDataURL('image/png');
            resolve(dataURL);
          };

          img.onerror = error => reject(error);
          img.src = event.target.result;
        };

        reader.onerror = error => reject(error);
        reader.readAsDataURL(file);
      });
    }

    /**
     * Escapes CSV values by wrapping in quotes if necessary and escaping internal quotes.
     *
     * @param {string} value
     * @returns {string}
     */
    function escapeCsvValue(value) {
      if (value == null) return '';
      const stringValue = value.toString();
      if (stringValue.includes('"')) {
        const escaped = stringValue.replace(/"/g, '""');
        return `"${escaped}"`;
      }
      if (stringValue.includes(',') || stringValue.includes('\n') || stringValue.includes('\r')) {
        return `"${stringValue}"`;
      }
      return stringValue;
    }

    /**
     * Triggers a download of CSV content as a file.
     *
     * @param {string} csvText
     * @param {string} filename
     */
    function downloadCsv(csvText, filename) {
      const blob = new Blob([csvText], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>