FROM nvidia/cuda:12.1.1-cudnn8-runtime-ubuntu22.04

# Install system dependencies + Python
USER root
RUN apt-get update && apt-get install -y --no-install-recommends \
    python3 python3-pip python3-dev build-essential git wget curl ca-certificates && \
    rm -rf /var/lib/apt/lists/*

# Ensure pip is up to date
RUN python3 -m pip install --upgrade pip

# Install JupyterLab + common Python libraries (from PyPI)
RUN python3 -m pip install --no-cache-dir \
    jupyterlab \
    numpy \
    pandas \
    matplotlib \
    seaborn \
    scikit-learn \
    tensorflow

# Install PyTorch separately from the CUDA 12.1 wheel index
RUN python3 -m pip install --no-cache-dir \
    torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu121

# Create non-root jovyan user
RUN useradd -m jovyan && chown -R jovyan:jovyan /home/jovyan
USER jovyan
WORKDIR /home/jovyan/work

# Add libs folder to PYTHONPATH
ENV PYTHONPATH="/home/jovyan/work/libs:${PYTHONPATH}"

# Expose port
EXPOSE 8888

# Default command: JupyterLab with no token
CMD ["python3", "-m", "jupyterlab", "--ip=0.0.0.0", "--no-browser", "--NotebookApp.token=''"]
